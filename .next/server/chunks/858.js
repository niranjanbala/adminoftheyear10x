exports.id=858,exports.ids=[858],exports.modules={5294:(a,b,c)=>{"use strict";c.d(b,{YO:()=>i,gx:()=>j,ru:()=>h});var d=c(2190),e=c(1223),f=c(4999),g=c(6710);function h(a,b={}){return async c=>{try{let h=(0,e.createRouteHandlerClient)({cookies:f.UL}),{data:{session:i},error:j}=await h.auth.getSession();if(j||!i)return d.NextResponse.json({error:"Authentication required"},{status:401});let k=await g.Dv.getById(i.user.id);if(!k)return d.NextResponse.json({error:"User not found"},{status:404});if(b.requireVerified&&"verified"!==k.verification_status)return d.NextResponse.json({error:"Account verification required"},{status:403});if(b.requireRole){let a={participant:0,voter:1,organizer:2,super_admin:3},c=a[k.role],e=a[b.requireRole];if(c<e)return d.NextResponse.json({error:"Insufficient permissions"},{status:403})}let l={id:k.id,email:k.email,hubspot_id:k.hubspot_id,display_name:k.display_name,role:k.role,verification_status:k.verification_status};return await a(c,{user:l,supabase:h})}catch(a){return console.error("Auth middleware error:",a),d.NextResponse.json({error:"Internal server error"},{status:500})}}}function i(a,b){let c=new Map;return async e=>{let f=b.keyGenerator?b.keyGenerator(e):e.headers.get("x-forwarded-for")||e.headers.get("x-real-ip")||"anonymous",g=Date.now(),h=g-b.windowMs;c.forEach((a,b)=>{a.resetTime<h&&c.delete(b)});let i=c.get(f)||{count:0,resetTime:g+b.windowMs};return i.count>=b.maxRequests&&i.resetTime>g?d.NextResponse.json({error:"Rate limit exceeded"},{status:429}):(i.count++,c.set(f,i),await a(e))}}function j(a,b={}){return async c=>{if("OPTIONS"===c.method)return new d.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":Array.isArray(b.origin)?b.origin.join(", "):b.origin||"*","Access-Control-Allow-Methods":b.methods?.join(", ")||"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":b.headers?.join(", ")||"Content-Type, Authorization","Access-Control-Max-Age":"86400"}});let e=await a(c);return e.headers.set("Access-Control-Allow-Origin",Array.isArray(b.origin)?b.origin.join(", "):b.origin||"*"),e}}},5853:a=>{function b(a){var b=Error("Cannot find module '"+a+"'");throw b.code="MODULE_NOT_FOUND",b}b.keys=()=>[],b.resolve=b,b.id=5853,a.exports=b},6487:()=>{},6621:(a,b,c)=>{"use strict";c.d(b,{N:()=>g});var d=c(3008);let e=process.env.NEXT_PUBLIC_SUPABASE_URL||"https://placeholder.supabase.co",f=process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY||"placeholder-key",g=(0,d.UU)(e,f)},6710:(a,b,c)=>{"use strict";c.d(b,{Dv:()=>e});var d=c(6621);let e={async getById(a){let{data:b,error:c}=await d.N.from("users").select("*").eq("id",a).single();if(c)throw c;return b},async getByHubSpotId(a){let{data:b,error:c}=await d.N.from("users").select("*").eq("hubspot_id",a).single();if(c&&"PGRST116"!==c.code)throw c;return b},async create(a){let{data:b,error:c}=await d.N.from("users").insert(a).select().single();if(c)throw c;return b},async update(a,b){let{data:c,error:e}=await d.N.from("users").update(b).eq("id",a).select().single();if(e)throw e;return c},async getVerifiedUsers(){let{data:a,error:b}=await d.N.from("users").select("*").eq("verification_status","verified");if(b)throw b;return a}}},8335:()=>{},8979:(a,b,c)=>{"use strict";c.d(b,{Rk:()=>g,wG:()=>h});var d=c(6621),e=c(6710);class f{constructor(){this.clientId=process.env.HUBSPOT_CLIENT_ID,this.clientSecret=process.env.HUBSPOT_CLIENT_SECRET,this.redirectUri=process.env.HUBSPOT_REDIRECT_URI}getAuthorizationUrl(a){let b=new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,scope:"oauth contacts",response_type:"code",...a&&{state:a}});return`https://app.hubspot.com/oauth/authorize?${b.toString()}`}async exchangeCodeForTokens(a){let b=await fetch("https://api.hubapi.com/oauth/v1/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"authorization_code",client_id:this.clientId,client_secret:this.clientSecret,redirect_uri:this.redirectUri,code:a})});if(!b.ok){let a=await b.text();throw Error(`HubSpot token exchange failed: ${a}`)}return b.json()}async refreshAccessToken(a){let b=await fetch("https://api.hubapi.com/oauth/v1/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"refresh_token",client_id:this.clientId,client_secret:this.clientSecret,refresh_token:a})});if(!b.ok){let a=await b.text();throw Error(`HubSpot token refresh failed: ${a}`)}return b.json()}async getUserProfile(a){let b=await fetch("https://api.hubapi.com/oauth/v1/access-tokens/"+a);if(!b.ok)throw Error("Failed to verify HubSpot access token");let c=await b.json(),d=await fetch(`https://api.hubapi.com/contacts/v1/contact/email/${c.user}/profile`,{headers:{Authorization:`Bearer ${a}`}});if(!d.ok)return{id:c.user_id.toString(),email:c.user,firstName:"",lastName:""};let e=await d.json();return{id:e.vid?.toString()||c.user_id.toString(),email:c.user,firstName:e.properties?.firstname?.value||"",lastName:e.properties?.lastname?.value||"",properties:{hs_is_admin:e.properties?.hs_is_admin?.value==="true",company:e.properties?.company?.value,jobtitle:e.properties?.jobtitle?.value}}}async verifyHubSpotAccount(a){try{let b=await this.getUserProfile(a);return{isValid:!0,isAdmin:b.properties?.hs_is_admin||!1,profile:b}}catch(a){return console.error("HubSpot verification failed:",a),{isValid:!1,isAdmin:!1,profile:null}}}}async function g(a,b){try{let b=await e.Dv.getByHubSpotId(a.id),c={hubspot_id:a.id,email:a.email,display_name:`${a.firstName} ${a.lastName}`.trim()||a.email,verification_status:"verified",role:a.properties?.hs_is_admin?"organizer":"participant"};if(b){let f=await e.Dv.update(b.id,c),{data:g,error:h}=await d.N.auth.signInWithPassword({email:a.email,password:"hubspot-oauth-"+a.id});return h&&h.message.includes("Invalid login credentials")&&await d.N.auth.signUp({email:a.email,password:"hubspot-oauth-"+a.id,options:{data:{hubspot_id:a.id,display_name:c.display_name}}}),f}{let b=await e.Dv.create(c);return await d.N.auth.signUp({email:a.email,password:"hubspot-oauth-"+a.id,options:{data:{hubspot_id:a.id,display_name:c.display_name}}}),b}}catch(a){throw console.error("Error creating/updating user:",a),a}}let h=new f}};